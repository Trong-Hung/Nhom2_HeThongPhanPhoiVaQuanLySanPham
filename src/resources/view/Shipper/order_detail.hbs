<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow rounded">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0"><i class="bi bi-receipt"></i> Chi tiáº¿t Ä‘Æ¡n hÃ ng</h4>
        </div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-sm-4">MÃ£ Ä‘Æ¡n:</dt>
            <dd class="col-sm-8">{{order._id}}</dd>

            <dt class="col-sm-4">Há» tÃªn:</dt>
            <dd class="col-sm-8">{{order.name}}</dd>

            <dt class="col-sm-4">SÄT:</dt>
            <dd class="col-sm-8">{{order.phone}}</dd>

            <dt class="col-sm-4">Äá»‹a chá»‰ giao:</dt>
            <dd class="col-sm-8">{{order.address}}</dd>

            <dt class="col-sm-4">Kho láº¥y hÃ ng:</dt>
            <dd class="col-sm-8">{{#if order.warehouseId}}{{order.warehouseId.name}}{{/if}}</dd>

            <dt class="col-sm-4">Äá»‹a chá»‰ kho:</dt>
            <dd class="col-sm-8">{{#if order.warehouseId}}{{order.warehouseId.address}}{{/if}}</dd>

            <dt class="col-sm-4">Tráº¡ng thÃ¡i:</dt>
            <dd class="col-sm-8">
              <span class="badge 
                {{#if (eq order.status 'Äang váº­n chuyá»ƒn')}}bg-warning text-dark
                {{else if (eq order.status 'ÄÃ£ giao')}}bg-success
                {{else}}bg-secondary{{/if}}">
                {{order.status}}
              </span>
            </dd>

            <dt class="col-sm-4">HÃ¬nh thá»©c thanh toÃ¡n:</dt>
            <dd class="col-sm-8">{{order.paymentMethod}}</dd>
            <dt class="col-sm-4">Tá»•ng tiá»n:</dt>
<dd class="col-sm-8 fw-bold text-success">{{order.totalPrice}} â‚«</dd>

            <dt class="col-sm-4">NgÃ y Ä‘áº·t:</dt>
            <dd class="col-sm-8">{{order.createdAt}}</dd>
          </dl>
          <h5 class="mt-4 mb-3">ğŸ›’ Danh sÃ¡ch máº·t hÃ ng trong Ä‘Æ¡n</h5>
<table class="table table-bordered align-middle">
  <thead class="table-light">
    <tr>
      <th>TÃªn sáº£n pháº©m</th>
      <th>GiÃ¡</th>
      <th>Sá»‘ lÆ°á»£ng</th>
      <th>ThÃ nh tiá»n</th>
    </tr>
  </thead>
  <tbody>
    {{#each order.items}}
      <tr>
        <td>{{this.name}}</td>
        <td>{{this.price}} â‚«</td>
        <td>{{this.quantity}}</td>
        <td class="fw-bold">{{multiply this.price this.quantity}} â‚«</td>
      </tr>
    {{/each}}
  </tbody>
</table>

          {{#if order.customerLocation.latitude}}
            <div id="map" style="height: 350px; margin-top: 24px; border-radius: 8px; overflow: hidden;"></div>
            <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
            <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
            <script>
              var warehouseLat = {{order.warehouseId.location.latitude}};
              var warehouseLng = {{order.warehouseId.location.longitude}};
              var customerLat = {{order.customerLocation.latitude}};
              var customerLng = {{order.customerLocation.longitude}};

              var map = L.map('map').setView([warehouseLat, warehouseLng], 13);

              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap'
              }).addTo(map);

              var warehouseMarker = L.marker([warehouseLat, warehouseLng]).addTo(map)
                .bindPopup('ğŸ¢ Kho hÃ ng').openPopup();

              var customerMarker = L.marker([customerLat, customerLng]).addTo(map)
                .bindPopup('ğŸ  KhÃ¡ch hÃ ng');

              // ğŸ›£ï¸ Sá»­ dá»¥ng OSRM Ä‘á»ƒ láº¥y tuyáº¿n Ä‘Æ°á»ng thá»±c táº¿
              async function getOSRMRoute() {
                try {
                  const osrmUrl = `http://127.0.0.1:5000/route/v1/driving/${warehouseLng},${warehouseLat};${customerLng},${customerLat}?steps=true&geometries=geojson`;
                  
                  const response = await fetch(osrmUrl);
                  const data = await response.json();

                  if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    
                    // Váº½ tuyáº¿n Ä‘Æ°á»ng thá»±c táº¿
                    const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    var routePolyline = L.polyline(routeCoordinates, {
                      color: 'red', 
                      weight: 4,
                      opacity: 0.8
                    }).addTo(map);

                    // Fit bounds Ä‘á»ƒ hiá»ƒn thá»‹ toÃ n bá»™ tuyáº¿n Ä‘Æ°á»ng
                    map.fitBounds(routePolyline.getBounds());

                    // Hiá»ƒn thá»‹ thÃ´ng tin tuyáº¿n Ä‘Æ°á»ng
                    const distance = (route.distance / 1000).toFixed(2);
                    const duration = Math.round(route.duration / 60);
                    
                    const routeInfo = L.control({position: 'topright'});
                    routeInfo.onAdd = function(map) {
                      const div = L.DomUtil.create('div', 'route-info');
                      div.innerHTML = `
                        <div style="background: white; padding: 10px; border-radius: 5px; box-shadow: 0 1px 5px rgba(0,0,0,0.2);">
                          <strong>ğŸ“Š ThÃ´ng tin tuyáº¿n Ä‘Æ°á»ng:</strong><br>
                          ğŸ›£ï¸ Khoáº£ng cÃ¡ch: ${distance} km<br>
                          â±ï¸ Thá»i gian: ${duration} phÃºt<br>
                          ğŸš› Tuyáº¿n Ä‘Æ°á»ng tá»‘i Æ°u
                        </div>
                      `;
                      return div;
                    };
                    routeInfo.addTo(map);

                  } else {
                    console.log('âš ï¸ KhÃ´ng thá»ƒ láº¥y tuyáº¿n Ä‘Æ°á»ng tá»« OSRM, sá»­ dá»¥ng Ä‘Æ°á»ng tháº³ng');
                    // Fallback vá» Ä‘Æ°á»ng tháº³ng náº¿u OSRM khÃ´ng hoáº¡t Ä‘á»™ng
                    var latlngs = [[warehouseLat, warehouseLng], [customerLat, customerLng]];
                    var polyline = L.polyline(latlngs, {color: 'blue', dashArray: '5, 10'}).addTo(map);
                    map.fitBounds(polyline.getBounds());
                  }
                } catch (error) {
                  console.log('âŒ Lá»—i káº¿t ná»‘i OSRM:', error);
                  // Fallback vá» Ä‘Æ°á»ng tháº³ng náº¿u cÃ³ lá»—i
                  var latlngs = [[warehouseLat, warehouseLng], [customerLat, customerLng]];
                  var polyline = L.polyline(latlngs, {color: 'blue', dashArray: '5, 10'}).addTo(map);
                  map.fitBounds(polyline.getBounds());
                }
              }

              // Gá»i hÃ m láº¥y tuyáº¿n Ä‘Æ°á»ng
              getOSRMRoute();
            </script>
            <a
              class="btn btn-outline-primary mt-3"
              target="_blank"
              href="https://www.google.com/maps/dir/?api=1&origin={{order.warehouseId.location.latitude}},{{order.warehouseId.location.longitude}}&destination={{order.customerLocation.latitude}},{{order.customerLocation.longitude}}&travelmode=driving"
            >
              <i class="bi bi-geo-alt"></i> Chá»‰ Ä‘Æ°á»ng Google Maps
            </a>
          {{else}}
            <p class="text-danger mt-3">KhÃ´ng cÃ³ vá»‹ trÃ­ khÃ¡ch hÃ ng Ä‘á»ƒ hiá»ƒn thá»‹ báº£n Ä‘á»“!</p>
          {{/if}}

          {{#if (eq order.status "Äang váº­n chuyá»ƒn")}}
            <form method="POST" action="/shipper/donhang/mark-delivered/{{order._id}}" class="mt-4">
              <button class="btn btn-success w-100"><i class="bi bi-check-circle"></i> ÄÃ£ giao</button>
            </form>
          {{/if}}

          <a href="/shipper/dang_van_chuyen" class="btn btn-link mt-3"><i class="bi bi-arrow-left"></i> Quay láº¡i danh sÃ¡ch</a>
        </div>
      </div>
    </div>
  </div>
</div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">