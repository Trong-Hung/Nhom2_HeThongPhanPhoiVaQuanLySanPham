<h3>Chi tiết đơn hàng</h3>
<p><strong>Mã đơn:</strong> {{order._id}}</p>
<p><strong>Họ tên:</strong> {{order.name}}</p>
<p><strong>SĐT:</strong> {{order.phone}}</p>
<p><strong>Địa chỉ giao:</strong> {{order.address}}</p>
<p><strong>Kho lấy hàng:</strong> {{#if order.warehouseId}}{{order.warehouseId.name}}{{/if}}</p>
<p><strong>Địa chỉ kho:</strong> {{#if order.warehouseId}}{{order.warehouseId.address}}{{/if}}</p>
<p><strong>Trạng thái:</strong> {{order.status}}</p>
<p><strong>Hình thức thanh toán:</strong> {{order.paymentMethod}}</p>
<p><strong>Ngày đặt:</strong> {{order.createdAt}}</p>

<form method="POST" action="/admin/donhang/update/{{order._id}}">
  <label for="status">Cập nhật trạng thái:</label>
  <select name="status" id="status" class="form-select">
    <option value="Chờ xác nhận" {{#if (eq order.status "Chờ xác nhận")}}selected{{/if}}>Chờ xác nhận</option>
    <option value="Đang sắp xếp" {{#if (eq order.status "Đang sắp xếp")}}selected{{/if}}>Đang sắp xếp</option>
    <option value="Đang vận chuyển" {{#if (eq order.status "Đang vận chuyển")}}selected{{/if}}>Đang vận chuyển</option>
    <option value="Đã giao" {{#if (eq order.status "Đã giao")}}selected{{/if}}>Đã giao</option>
    <option value="Đã hủy" {{#if (eq order.status "Đã hủy")}}selected{{/if}}>Đã hủy</option>
  </select>
  <button class="btn btn-primary btn-sm mt-1">Cập nhật</button>
</form>

{{#if order.customerLocation.latitude}}
  <div id="map" style="height: 400px; margin-top: 16px;"></div>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    var warehouseLat = {{order.warehouseId.location.latitude}};
    var warehouseLng = {{order.warehouseId.location.longitude}};
    var customerLat = {{order.customerLocation.latitude}};
    var customerLng = {{order.customerLocation.longitude}};

    var map = L.map('map').setView([warehouseLat, warehouseLng], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    var warehouseMarker = L.marker([warehouseLat, warehouseLng]).addTo(map)
      .bindPopup('Kho hàng').openPopup();

    var customerMarker = L.marker([customerLat, customerLng]).addTo(map)
      .bindPopup('Khách hàng');

    var latlngs = [
      [warehouseLat, warehouseLng],
      [customerLat, customerLng]
    ];
    var polyline = L.polyline(latlngs, {color: 'blue'}).addTo(map);
    map.fitBounds(polyline.getBounds());
  </script>
  {{#if order.customerLocation.latitude}}
  <a
    class="btn btn-primary mt-2"
    target="_blank"
    href="https://www.google.com/maps/dir/?api=1&origin={{order.warehouseId.location.latitude}},{{order.warehouseId.location.longitude}}&destination={{order.customerLocation.latitude}},{{order.customerLocation.longitude}}&travelmode=driving"
  >
    Chỉ đường Google Maps
  </a>
{{/if}}
{{else}}
  <p class="text-danger">Không có vị trí khách hàng để hiển thị bản đồ!</p>
{{/if}}
{{#if (eq order.status "Đang vận chuyển")}}
  <form method="POST" action="/shipper/donhang/mark-delivered/{{order._id}}">
    <button class="btn btn-success">Đã giao</button>
  </form>
{{/if}}

<a href="/admin/qldonhang">Quay lại danh sách</a>