<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="text-primary mb-0"><i class="bi bi-truck"></i> Phiáº¿u Äiá»u Chuyá»ƒn Äang Váº­n Chuyá»ƒn</h3>
    
    {{#if transfers.length}}
    <div class="d-flex gap-2">
      <button 
        id="optimizeBtn" 
        class="btn btn-warning btn-sm"
        onclick="optimizeTransferRoute()"
        title="Tá»‘i Æ°u láº¡i thá»© tá»± váº­n chuyá»ƒn Ä‘á»ƒ tiáº¿t kiá»‡m thá»i gian">
        <i class="bi bi-geo-alt"></i> Tá»‘i Æ°u lá»™ trÃ¬nh
      </button>
      <div id="optimizeSpinner" class="spinner-border spinner-border-sm text-warning d-none" role="status">
        <span class="visually-hidden">Äang tá»‘i Æ°u...</span>
      </div>
    </div>
    {{/if}}
  </div>

  {{#if transfers.length}}
  <div id="optimizeAlert" class="alert alert-info d-none" role="alert">
    <i class="bi bi-info-circle"></i>
    <span id="optimizeMessage">Äang tá»‘i Æ°u lá»™ trÃ¬nh váº­n chuyá»ƒn...</span>
  </div>
  {{/if}}

  <div class="table-responsive shadow-sm rounded">
    <table class="table table-striped table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th scope="col" style="width: 100px;">Thá»© tá»±</th>
          <th scope="col" style="width: 130px;">MÃ£ phiáº¿u</th>
          <th scope="col">Kho nguá»“n</th>
          <th scope="col">Kho Ä‘Ã­ch</th>
          <th scope="col">Äá»‹a chá»‰ Ä‘áº¿n</th>
          <th scope="col" style="width: 120px;">Tráº¡ng thÃ¡i</th>
          <th scope="col" style="width: 180px;">Chá»©c nÄƒng</th>
        </tr>
      </thead>
      <tbody>
        {{#each transfers}}
        <tr>
          <td>
            {{#if this.routeOrder}}
              {{#if (eq this.routeOrder 0)}}
                <span class="badge bg-info fs-6">ğŸ  Kho</span>
              {{else}}
                <span class="badge bg-primary fs-6">ğŸ“ {{this.routeOrder}}</span>
              {{/if}}
            {{else}}
              <span class="badge bg-secondary">--</span>
            {{/if}}
          </td>
          <td>
            <a href="/shipper/transfers/{{this._id}}" class="text-decoration-none">
              <small>{{this.transferId}}</small>
            </a>
          </td>
          <td><strong>{{this.sourceWarehouse.name}}</strong></td>
          <td><strong>{{this.destinationWarehouse.name}}</strong></td>
          <td>{{this.destinationWarehouse.address}}</td>
          <td>
            {{#if (eq this.status "Äang váº­n chuyá»ƒn")}}
              <span class="badge bg-warning text-dark">{{this.status}}</span>
            {{else if (eq this.status "ÄÃ£ giao")}}
              <span class="badge bg-success">{{this.status}}</span>
            {{else}}
              <span class="badge bg-secondary">{{this.status}}</span>
            {{/if}}
          </td>
          <td>
            <div class="btn-group-vertical" role="group">
              <a href="/shipper/transfers/{{this._id}}" class="btn btn-sm btn-outline-secondary">
                ğŸ“„ Chi tiáº¿t
              </a>
              <form action="/shipper/transfers/mark-delivered/{{this._id}}" method="POST" style="display: inline;" onsubmit="return confirm('XÃ¡c nháº­n Ä‘Ã£ váº­n chuyá»ƒn thÃ nh cÃ´ng?')">
                <button type="submit" class="btn btn-sm btn-success mt-1">
                  âœ… ÄÃ£ giao
                </button>
              </form>
            </div>
          </td>
        </tr>
        {{/each}}
      </tbody>
    </table>
    {{^transfers.length}}
      <p class="text-muted text-center fs-5 my-4">ğŸš« Hiá»‡n chÆ°a cÃ³ phiáº¿u Ä‘iá»u chuyá»ƒn nÃ o Ä‘ang váº­n chuyá»ƒn.</p>
    {{/transfers.length}}
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

<script>
async function optimizeTransferRoute() {
  const btn = document.getElementById('optimizeBtn');
  const spinner = document.getElementById('optimizeSpinner');
  const alert = document.getElementById('optimizeAlert');
  const message = document.getElementById('optimizeMessage');
  
  // Show loading state
  btn.disabled = true;
  spinner.classList.remove('d-none');
  alert.classList.remove('d-none', 'alert-success', 'alert-danger');
  alert.classList.add('alert-info');
  message.textContent = 'Äang tá»‘i Æ°u lá»™ trÃ¬nh váº­n chuyá»ƒn...';
  
  try {
    const response = await fetch('/shipper/optimize-transfer-routes', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({})
    });
    
    const result = await response.json();
    
    if (result.success) {
      // Success - show message and reload page
      alert.classList.remove('alert-info');
      alert.classList.add('alert-success');
      message.innerHTML = `<i class="bi bi-check-circle"></i> ${result.message}`;
      
      // Reload page after 2 seconds to show updated order
      setTimeout(() => {
        window.location.reload();
      }, 2000);
      
    } else {
      // Error
      alert.classList.remove('alert-info');
      alert.classList.add('alert-danger');
      message.innerHTML = `<i class="bi bi-exclamation-circle"></i> ${result.message}`;
    }
    
  } catch (error) {
    console.error('Transfer optimization error:', error);
    alert.classList.remove('alert-info');
    alert.classList.add('alert-danger');
    message.innerHTML = `<i class="bi bi-exclamation-circle"></i> Lá»—i káº¿t ná»‘i. Vui lÃ²ng thá»­ láº¡i.`;
  }
  
  // Hide loading state
  btn.disabled = false;
  spinner.classList.add('d-none');
  
  // Hide alert after 5 seconds if it's an error
  if (alert.classList.contains('alert-danger')) {
    setTimeout(() => {
      alert.classList.add('d-none');
    }, 5000);
  }
}
</script>