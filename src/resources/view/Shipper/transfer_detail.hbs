<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow rounded">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0"><i class="bi bi-truck"></i> Chi ti·∫øt phi·∫øu ƒëi·ªÅu chuy·ªÉn</h4>
        </div>
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-sm-4">M√£ phi·∫øu:</dt>
            <dd class="col-sm-8">{{transfer.transferId}}</dd>

            <dt class="col-sm-4">Kho ngu·ªìn:</dt>
            <dd class="col-sm-8">{{transfer.sourceWarehouse.name}}</dd>

            <dt class="col-sm-4">ƒê·ªãa ch·ªâ kho ngu·ªìn:</dt>
            <dd class="col-sm-8">{{transfer.sourceWarehouse.address}}</dd>

            <dt class="col-sm-4">Kho ƒë√≠ch:</dt>
            <dd class="col-sm-8">{{transfer.destinationWarehouse.name}}</dd>

            <dt class="col-sm-4">ƒê·ªãa ch·ªâ kho ƒë√≠ch:</dt>
            <dd class="col-sm-8">{{transfer.destinationWarehouse.address}}</dd>

            <dt class="col-sm-4">Tr·∫°ng th√°i:</dt>
            <dd class="col-sm-8">
              <span class="badge 
                {{#if (eq transfer.status 'ƒêang v·∫≠n chuy·ªÉn')}}bg-warning text-dark
                {{else if (eq transfer.status 'ƒê√£ giao')}}bg-success
                {{else}}bg-secondary{{/if}}">
                {{transfer.status}}
              </span>
            </dd>

            <dt class="col-sm-4">Ng√†y t·∫°o:</dt>
            <dd class="col-sm-8">{{transfer.createdAt}}</dd>
          </dl>
          <h5 class="mt-4 mb-3">üõí Danh s√°ch s·∫£n ph·∫©m ƒëi·ªÅu chuy·ªÉn</h5>
<table class="table table-bordered align-middle">
  <thead class="table-light">
    <tr>
      <th>T√™n s·∫£n ph·∫©m</th>
      <th>S·ªë l∆∞·ª£ng</th>
    </tr>
  </thead>
  <tbody>
    {{#each transfer.items}}
      <tr>
        <td>{{this.productId.name}}</td>
        <td>{{this.quantity}}</td>
      </tr>
    {{/each}}
  </tbody>
</table>

          {{#if transfer.sourceWarehouse.location}}
            <div id="map" style="height: 350px; margin-top: 24px; border-radius: 8px; overflow: hidden;"></div>
            <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
            <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
            <script>
              var sourceLat = {{transfer.sourceWarehouse.location.latitude}};
              var sourceLng = {{transfer.sourceWarehouse.location.longitude}};
              var destLat = {{transfer.destinationWarehouse.location.latitude}};
              var destLng = {{transfer.destinationWarehouse.location.longitude}};

              var map = L.map('map').setView([sourceLat, sourceLng], 10);

              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap'
              }).addTo(map);

              var sourceMarker = L.marker([sourceLat, sourceLng]).addTo(map)
                .bindPopup('üè¢ Kho ngu·ªìn: {{transfer.sourceWarehouse.name}}').openPopup();

              var destMarker = L.marker([destLat, destLng]).addTo(map)
                .bindPopup('üè¨ Kho ƒë√≠ch: {{transfer.destinationWarehouse.name}}');

              // üõ£Ô∏è S·ª≠ d·ª•ng OSRM ƒë·ªÉ l·∫•y tuy·∫øn ƒë∆∞·ªùng th·ª±c t·∫ø
              async function getOSRMRoute() {
                try {
                  const osrmUrl = `http://127.0.0.1:5000/route/v1/driving/${sourceLng},${sourceLat};${destLng},${destLat}?steps=true&geometries=geojson`;
                  
                  const response = await fetch(osrmUrl);
                  const data = await response.json();

                  if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    
                    // V·∫Ω tuy·∫øn ƒë∆∞·ªùng th·ª±c t·∫ø
                    const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    var routePolyline = L.polyline(routeCoordinates, {
                      color: 'red', 
                      weight: 4,
                      opacity: 0.8
                    }).addTo(map);

                    // Fit bounds ƒë·ªÉ hi·ªÉn th·ªã to√†n b·ªô tuy·∫øn ƒë∆∞·ªùng
                    map.fitBounds(routePolyline.getBounds());

                    // Hi·ªÉn th·ªã th√¥ng tin tuy·∫øn ƒë∆∞·ªùng
                    const distance = (route.distance / 1000).toFixed(2);
                    const duration = Math.round(route.duration / 60);
                    
                    const routeInfo = L.control({position: 'topright'});
                    routeInfo.onAdd = function(map) {
                      const div = L.DomUtil.create('div', 'route-info');
                      div.innerHTML = `
                        <div style="background: white; padding: 10px; border-radius: 5px; box-shadow: 0 1px 5px rgba(0,0,0,0.2);">
                          <strong>üìä Th√¥ng tin tuy·∫øn ƒë∆∞·ªùng:</strong><br>
                          üõ£Ô∏è Kho·∫£ng c√°ch: ${distance} km<br>
                          ‚è±Ô∏è Th·ªùi gian: ${duration} ph√∫t<br>
                          üöõ Tuy·∫øn ƒë∆∞·ªùng t·ªëi ∆∞u
                        </div>
                      `;
                      return div;
                    };
                    routeInfo.addTo(map);

                  } else {
                    console.log('‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y tuy·∫øn ƒë∆∞·ªùng t·ª´ OSRM, s·ª≠ d·ª•ng ƒë∆∞·ªùng th·∫≥ng');
                    // Fallback v·ªÅ ƒë∆∞·ªùng th·∫≥ng n·∫øu OSRM kh√¥ng ho·∫°t ƒë·ªông
                    var latlngs = [[sourceLat, sourceLng], [destLat, destLng]];
                    var polyline = L.polyline(latlngs, {color: 'blue', dashArray: '5, 10'}).addTo(map);
                    map.fitBounds(polyline.getBounds());
                  }
                } catch (error) {
                  console.log('‚ùå L·ªói k·∫øt n·ªëi OSRM:', error);
                  // Fallback v·ªÅ ƒë∆∞·ªùng th·∫≥ng n·∫øu c√≥ l·ªói
                  var latlngs = [[sourceLat, sourceLng], [destLat, destLng]];
                  var polyline = L.polyline(latlngs, {color: 'blue', dashArray: '5, 10'}).addTo(map);
                  map.fitBounds(polyline.getBounds());
                }
              }

              // G·ªçi h√†m l·∫•y tuy·∫øn ƒë∆∞·ªùng
              getOSRMRoute();
            </script>
            <a
              class="btn btn-outline-primary mt-3"
              target="_blank"
              href="https://www.google.com/maps/dir/?api=1&origin={{transfer.sourceWarehouse.location.latitude}},{{transfer.sourceWarehouse.location.longitude}}&destination={{transfer.destinationWarehouse.location.latitude}},{{transfer.destinationWarehouse.location.longitude}}&travelmode=driving"
            >
              <i class="bi bi-geo-alt"></i> Ch·ªâ ƒë∆∞·ªùng Google Maps
            </a>
          {{else}}
            <p class="text-danger mt-3">Kh√¥ng c√≥ v·ªã tr√≠ kho ƒë·ªÉ hi·ªÉn th·ªã b·∫£n ƒë·ªì!</p>
          {{/if}}

          {{#if (eq transfer.status "ƒêang v·∫≠n chuy·ªÉn")}}
            <form method="POST" action="/shipper/transfer/mark-delivered/{{transfer._id}}" class="mt-4">
              <button class="btn btn-success w-100"><i class="bi bi-check-circle"></i> ƒê√£ giao</button>
            </form>
          {{/if}}

          <a href="/shipper/transfers/dang-van-chuyen" class="btn btn-link mt-3"><i class="bi bi-arrow-left"></i> Quay l·∫°i danh s√°ch</a>
        </div>
      </div>
    </div>
  </div>
</div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
              <div class="mb-3">
                <label class="form-label font-weight-bold">Ng√†y t·∫°o:</label>
                <p class="form-control-plaintext">{{formatDate
                    transfer.createdAt
                    "DD/MM/YYYY HH:mm"
                  }}</p>
              </div>
              {{#if transfer.deliveredAt}}
                <div class="mb-3">
                  <label class="form-label font-weight-bold">Ng√†y ho√†n th√†nh:</label>
                  <p class="form-control-plaintext">{{#if
                      transfer.deliveredAt
                    }}{{formatDate
                        transfer.deliveredAt
                        "DD/MM/YYYY HH:mm"
                      }}{{else}}Ch∆∞a giao{{/if}}</p>
                </div>
              {{/if}}
              {{#if transfer.assignedShipper}}
                <div class="mb-3">
                  <label class="form-label font-weight-bold">Shipper ph·ª• tr√°ch:</label>
                  <p class="form-control-plaintext">
                    <strong>{{transfer.assignedShipper.name}}</strong><br />
                    <small class="text-muted">üìû
                      {{transfer.assignedShipper.phone}}</small>
                  </p>
                </div>
              {{/if}}
            </div>
          </div>

          <!-- Danh s√°ch s·∫£n ph·∫©m -->
          <h5 class="text-info mb-3">üì¶ Danh S√°ch S·∫£n Ph·∫©m ƒêi·ªÅu Chuy·ªÉn</h5>
          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <thead class="table-light">
                <tr>
                  <th scope="col">STT</th>
                  <th scope="col">T√™n s·∫£n ph·∫©m</th>
                  <th scope="col">S·ªë l∆∞·ª£ng</th>
                  <th scope="col">Ghi ch√∫</th>
                </tr>
              </thead>
              <tbody>
                {{#each transfer.items}}
                  <tr>
                    <td>{{@index}}</td>
                    <td>
                      <strong>{{this.productId.name}}</strong>
                      {{#if this.productId.price}}
                        <br /><small class="text-muted">Gi√°:
                          {{formatCurrency this.productId.price}}ƒë</small>
                      {{/if}}
                    </td>
                    <td><span class="badge bg-primary">{{this.quantity}}
                        sp</span></td>
                    <td>
                      {{#if this.note}}
                        {{this.note}}
                      {{else}}
                        <small class="text-muted">-</small>
                      {{/if}}
                    </td>
                  </tr>
                {{/each}}
              </tbody>
            </table>
          </div>

          <!-- Action buttons based on status -->
          <div class="mt-4 text-center">
            {{#if (eq transfer.status "ƒêang s·∫Øp x·∫øp")}}
              <form
                action="/shipper/transfers/confirm/{{transfer._id}}"
                method="POST"
                style="display: inline;"
              >
                <button
                  type="submit"
                  class="btn btn-success btn-lg"
                  onclick="return confirm('X√°c nh·∫≠n nh·∫≠n phi·∫øu ƒëi·ªÅu chuy·ªÉn n√†y?')"
                >
                  ‚úÖ X√°c Nh·∫≠n Nh·∫≠n Phi·∫øu
                </button>
              </form>
            {{else if (eq transfer.status "ƒêang v·∫≠n chuy·ªÉn")}}
              <form
                action="/shipper/transfers/mark-delivered/{{transfer._id}}"
                method="POST"
                style="display: inline;"
              >
                <button
                  type="submit"
                  class="btn btn-success btn-lg"
                  onclick="return confirm('X√°c nh·∫≠n ƒë√£ v·∫≠n chuy·ªÉn th√†nh c√¥ng t·ªõi kho ƒë√≠ch?')"
                >
                  ‚úÖ X√°c Nh·∫≠n ƒê√£ Giao
                </button>
              </form>
            {{else if (eq transfer.status "ƒê√£ giao")}}
              <span class="badge bg-success fs-6 p-3">
                ‚úÖ Phi·∫øu ƒëi·ªÅu chuy·ªÉn ƒë√£ ho√†n th√†nh
              </span>
            {{/if}}
          </div>

          <!-- Navigation buttons -->
          <div class="mt-4">
            <a href="javascript:history.back()" class="btn btn-secondary">
              ‚Üê Quay l·∫°i
            </a>

            {{#if (eq transfer.status "ƒêang s·∫Øp x·∫øp")}}
              <a
                href="/shipper/transfers/dang-sap-xep"
                class="btn btn-warning ms-2"
              >
                üìã Danh s√°ch ƒëang s·∫Øp x·∫øp
              </a>
            {{else if (eq transfer.status "ƒêang v·∫≠n chuy·ªÉn")}}
              <a
                href="/shipper/transfers/dang-van-chuyen"
                class="btn btn-info ms-2"
              >
                üöõ Danh s√°ch ƒëang v·∫≠n chuy·ªÉn
              </a>
            {{else}}
              <a href="/shipper/transfers/da-giao" class="btn btn-success ms-2">
                ‚úÖ Danh s√°ch ƒë√£ ho√†n th√†nh
              </a>
            {{/if}}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
/>