{{! filepath: c:\Users\trong\JAVASC\blog\src\resources\view\cart\payment.hbs }}
<div class="mt-4">
  <h3>Th√¥ng tin thanh to√°n</h3>

  {{#if cart.items.length}}
    <!-- Hi·ªÉn th·ªã danh s√°ch c√°c s·∫£n ph·∫©m ƒë√£ ch·ªçn -->
    <h4>S·∫£n ph·∫©m trong gi·ªè h√†ng</h4>
    <table class="table mt-4">
      <thead>
        <tr>
          <th scope="col">T√™n s·∫£n ph·∫©m</th>
          <th scope="col">Gi√°</th>
          <th scope="col">S·ªë l∆∞·ª£ng</th>
        </tr>
      </thead>
      <tbody>
        {{#each cart.items}}
          <tr>
            <td>{{this.name}}</td>
            <td>{{formatCurrency this.price}}</td>
            <td>{{this.quantity}}</td>
          </tr>
        {{/each}}
      </tbody>
    </table>

    <!-- Hi·ªÉn th·ªã t·ªïng s·ªë l∆∞·ª£ng v√† t·ªïng ti·ªÅn -->
    <div class="row mt-4">
      <div class="col-6">
        <p><strong>T·ªïng s·ªë l∆∞·ª£ng:</strong> {{totalQuantity}}</p>
      </div>
      <div class="col-6 text-right">
        <p><strong>T·ªïng ti·ªÅn:</strong> {{totalPrice}}</p>
      </div>
    </div>

    <!-- Form nh·∫≠p th√¥ng tin v√† ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n -->
    <form action="/cart/payment" method="POST">
      <div class="form-group">
        <label for="name">H·ªç t√™n</label>
        <input
          type="text"
          class="form-control"
          id="name"
          name="name"
          required
        />
      </div>
      <div class="form-group">
        <label for="phone">S·ªë ƒëi·ªán tho·∫°i</label>
        <input
          type="text"
          class="form-control"
          id="phone"
          name="phone"
          required
        />
      </div>
      <div class="form-group">
        <label for="email">Email (ƒë·ªÉ nh·∫≠n th√¥ng b√°o ƒë∆°n h√†ng)</label>
        <input
          type="email"
          class="form-control"
          id="email"
          name="email"
          placeholder="email@example.com"
        />
      </div>
      <div class="form-group">
        <label for="detail">ƒê·ªãa ch·ªâ chi ti·∫øt</label>
        <input
          type="text"
          class="form-control"
          id="detail"
          name="detail"
          placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng..."
          required
        />
      </div>

      <div class="form-group">
        <label for="province">T·ªânh/Th√†nh ph·ªë</label>
        <select
          class="form-control"
          id="province"
          name="province"
          required
        ></select>
        <input type="hidden" id="provinceName" name="provinceName" />
      </div>
      <div class="form-group">
        <label for="district">Qu·∫≠n/Huy·ªán</label>
        <select
          class="form-control"
          id="district"
          name="district"
          required
        ></select>
        <input type="hidden" id="districtName" name="districtName" />
      </div>
      <div class="form-group">
        <label for="ward">Ph∆∞·ªùng/X√£</label>
        <select class="form-control" id="ward" name="ward" required></select>
        <input type="hidden" id="wardName" name="wardName" />
      </div>

      <div class="form-group">
        <label><strong>Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n:</strong></label>
        <div class="form-check">
          <input
            class="form-check-input"
            type="radio"
            name="method"
            id="method-cash"
            value="cash"
            checked
          />
          <label class="form-check-label" for="method-cash">
            Thanh to√°n khi nh·∫≠n h√†ng
          </label>
        </div>
        <div class="form-check">
          <input
            class="form-check-input"
            type="radio"
            name="method"
            id="method-momo"
            value="momo"
          />
          <label class="form-check-label" for="method-momo">
            Thanh to√°n qua MoMo
          </label>
        </div>
      </div>

      <button type="submit" class="btn btn-primary btn-block">Thanh to√°n</button>
    </form>
  {{else}}
    <p>üõí Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.</p>
  {{/if}}
</div>

<script>
  const host = "https://esgoo.net/api-tinhthanh";

  // H√†m g·ªçi API chung
  async function callAPI(api) {
    try {
      const response = await fetch(api);
      const data = await response.json();
      // API esgoo tr·∫£ v·ªÅ: { error: 0, data: [...] }
      if (data.error === 0) {
        return data.data;
      }
      return [];
    } catch (error) {
      console.error("L·ªói g·ªçi API:", error);
      return [];
    }
  }

  // Render options v√†o th·∫ª Select
  function renderData(array, selectId, type) {
    let row = `<option value="" disabled selected>Ch·ªçn ${type}</option>`;
    array.forEach(element => {
      // id: m√£ s·ªë, full_name: t√™n ƒë·∫ßy ƒë·ªß
      row += `<option value="${element.id}" data-name="${element.full_name}">${element.full_name}</option>`;
    });
    document.querySelector("#" + selectId).innerHTML = row;
  }

  // Load T·ªânh/Th√†nh
  async function loadProvinces() {
    const data = await callAPI(host + "/1/0.htm");
    renderData(data, "province", "T·ªânh/Th√†nh ph·ªë");
  }

  // Load Qu·∫≠n/Huy·ªán
  async function loadDistricts(provinceId) {
    if (!provinceId) return;
    const data = await callAPI(host + "/2/" + provinceId + ".htm");
    renderData(data, "district", "Qu·∫≠n/Huy·ªán");
    // Reset ph∆∞·ªùng x√£
    renderData([], "ward", "Ph∆∞·ªùng/X√£");
  }

  // Load Ph∆∞·ªùng/X√£
  async function loadWards(districtId) {
    if (!districtId) return;
    const data = await callAPI(host + "/3/" + districtId + ".htm");
    renderData(data, "ward", "Ph∆∞·ªùng/X√£");
  }

  // C·∫≠p nh·∫≠t c√°c input hidden ƒë·ªÉ g·ª≠i t√™n v·ªÅ server
  function updateHiddenFields() {
    const provinceSel = document.getElementById("province");
    const districtSel = document.getElementById("district");
    const wardSel = document.getElementById("ward");

    // L·∫•y text t·ª´ option ƒëang ch·ªçn (data-name)
    if (provinceSel.selectedIndex > 0) {
      const pOption = provinceSel.options[provinceSel.selectedIndex];
      document.getElementById("provinceName").value = pOption.getAttribute("data-name");
    }

    if (districtSel.selectedIndex > 0) {
      const dOption = districtSel.options[districtSel.selectedIndex];
      document.getElementById("districtName").value = dOption.getAttribute("data-name");
    }

    if (wardSel.selectedIndex > 0) {
      const wOption = wardSel.options[wardSel.selectedIndex];
      document.getElementById("wardName").value = wOption.getAttribute("data-name");
    }
  }

  // S·ª± ki·ªán khi trang t·∫£i xong
  document.addEventListener("DOMContentLoaded", () => {
    loadProvinces();

    // Khi ch·ªçn T·ªânh -> Load Huy·ªán
    document.getElementById("province").addEventListener("change", function() {
      loadDistricts(this.value);
      updateHiddenFields();
    });

    // Khi ch·ªçn Huy·ªán -> Load X√£
    document.getElementById("district").addEventListener("change", function() {
      loadWards(this.value);
      updateHiddenFields();
    });

    // Khi ch·ªçn X√£ -> C·∫≠p nh·∫≠t t√™n
    document.getElementById("ward").addEventListener("change", function() {
      updateHiddenFields();
    });
  });
</script>