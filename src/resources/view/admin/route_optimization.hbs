<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>T·ªëi ∆∞u tuy·∫øn ƒë∆∞·ªùng giao h√†ng</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <style>
      #map {
        height: 600px;
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .control-panel {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .route-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #007bff;
        margin: 10px 0;
      }

      .shipper-route {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        background: white;
      }

      .shipper-route.active {
        border-color: #007bff;
        background: #f8f9ff;
      }

      .route-colors {
        display: inline-block;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 10px;
        border: 2px solid white;
      }

      .loading {
        text-align: center;
        padding: 40px;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        display: inline-block;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .marker-warehouse {
        background-color: #28a745;
        color: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
      }

      .marker-customer {
        background-color: #007bff;
        color: white;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
      }
    </style>
  </head>

  <body>
    <div class="container-fluid mt-4">
      <div class="row">
        <div class="col-12">
          <h2><i class="fas fa-route"></i> T·ªëi ∆∞u tuy·∫øn ƒë∆∞·ªùng giao h√†ng</h2>
          <p class="text-muted">H·ªá th·ªëng t·ª± ƒë·ªông t√≠nh to√°n tuy·∫øn ƒë∆∞·ªùng ng·∫Øn nh·∫•t
            v√† ph√¢n b·ªï ƒë∆°n h√†ng cho shipper</p>
        </div>
      </div>

      <!-- Control Panel -->
      <div class="row">
        <div class="col-md-4">
          <div class="control-panel">
            <h5><i class="fas fa-cog"></i> ƒêi·ªÅu khi·ªÉn</h5>

            <div class="mb-3">
              <label for="dateSelect" class="form-label">Ng√†y giao h√†ng:</label>
              <input
                type="date"
                class="form-control"
                id="dateSelect"
                value=""
              />
            </div>

            <div class="mb-3">
              <label for="warehouseSelect" class="form-label">Kho h√†ng:</label>
              <select class="form-select" id="warehouseSelect">
                <option value="">ƒêang t·∫£i...</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="algorithmSelect" class="form-label">Thu·∫≠t to√°n:</label>
              <select class="form-select" id="algorithmSelect">
                <option value="auto">T·ª± ƒë·ªông (Th√¥ng minh)</option>
                <option value="multi_vehicle">Multi-Vehicle VRP</option>
                <option value="nearest_neighbor">Nearest Neighbor</option>
                <option value="2opt">2-Opt Optimization</option>
              </select>
            </div>

            <button
              class="btn btn-primary w-100"
              id="optimizeBtn"
              onclick="optimizeRoutes()"
            >
              <i class="fas fa-magic"></i>
              T·ªëi ∆∞u tuy·∫øn ƒë∆∞·ªùng
            </button>

            <button
              class="btn btn-info w-100 mt-2"
              id="testOsrmBtn"
              onclick="testOSRM()"
            >
              <i class="fas fa-network-wired"></i>
              Test OSRM
            </button>
          </div>

          <!-- Route Summary -->
          <div class="control-panel" id="routeSummary" style="display: none;">
            <h5><i class="fas fa-chart-bar"></i> T√≥m t·∫Øt</h5>
            <div id="summaryContent"></div>
          </div>

          <!-- Shipper Routes -->
          <div class="control-panel" id="shipperRoutes" style="display: none;">
            <h5><i class="fas fa-users"></i> Tuy·∫øn ƒë∆∞·ªùng Shipper</h5>
            <div id="routesContent"></div>
          </div>
        </div>

        <div class="col-md-8">
          <!-- Map Container -->
          <div id="map"></div>

          <!-- Loading Overlay -->
          <div class="loading" id="loadingOverlay" style="display: none;">
            <div class="spinner"></div>
            <p>ƒêang t·ªëi ∆∞u tuy·∫øn ƒë∆∞·ªùng...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Bootstrap JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    ></script>

    <!-- Main Script -->
    <script>
      // Global variables let map; let routeData = null; let routeLayers = [];
      let markerLayers = []; const routeColors = ['#FF6B6B', '#4ECDC4',
      '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8']; // Initialize
      document.addEventListener('DOMContentLoaded', function() { initMap();
      initControls(); loadWarehouses(); }); function initMap() { // Initialize
      map centered on Ho Chi Minh City map = L.map('map').setView([10.8231,
      106.6297], 11); // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors' }).addTo(map);
      console.log('Map initialized'); } function initControls() { // Set default
      date to today const today = new Date().toISOString().split('T')[0];
      document.getElementById('dateSelect').value = today; } async function
      loadWarehouses() { try { const response = await fetch('/api/warehouses');
      // Assuming you have this endpoint if (response.ok) { const warehouses =
      await response.json(); const select =
      document.getElementById('warehouseSelect'); select.innerHTML = '';
      warehouses.forEach(warehouse => { const option =
      document.createElement('option'); option.value = warehouse._id;
      option.textContent = warehouse.name; select.appendChild(option); }); }
      else { // Fallback - use default warehouse const select =
      document.getElementById('warehouseSelect'); select.innerHTML = '<option
      value="default">Kho m·∫∑c ƒë·ªãnh (908 Ph·∫°m VƒÉn ƒê·ªìng)</option>'; } } catch
      (error) { console.error('Error loading warehouses:', error); const select
      = document.getElementById('warehouseSelect'); select.innerHTML = '<option
      value="default">Kho m·∫∑c ƒë·ªãnh (908 Ph·∫°m VƒÉn ƒê·ªìng)</option>'; } } async
      function optimizeRoutes() { const date =
      document.getElementById('dateSelect').value; const warehouseId =
      document.getElementById('warehouseSelect').value; const algorithm =
      document.getElementById('algorithmSelect').value; if (!date ||
      !warehouseId) { alert('Vui l√≤ng ch·ªçn ng√†y v√† kho h√†ng'); return; }
      showLoading(true); clearMap(); try { const response = await
      fetch(`/api/routes/optimize?warehouseId=${warehouseId}&date=${date}&algorithm=${algorithm}`,
      { headers: { 'Authorization': `Bearer ${getAuthToken()}` // Assuming JWT
      auth } }); const result = await response.json(); if (result.success) {
      routeData = result.data; displayRoutes(routeData);
      showRouteSummary(routeData); showShipperRoutes(routeData.routes); // Show
      success message showAlert('success', `T·ªëi ∆∞u th√†nh c√¥ng!
      ${result.message}`); } else { showAlert('danger', `L·ªói:
      ${result.message}`); } } catch (error) { console.error('Optimization
      error:', error); showAlert('danger', 'L·ªói k·∫øt n·ªëi server'); } finally {
      showLoading(false); } } function displayRoutes(data) { clearMap(); if
      (!data.routes || data.routes.length === 0) { showAlert('info', 'Kh√¥ng c√≥
      tuy·∫øn ƒë∆∞·ªùng n√†o ƒë·ªÉ hi·ªÉn th·ªã'); return; } // Add warehouse marker const
      warehouse = data.routes[0].vehicle; // Assuming warehouse info is
      available if (warehouse) { const warehouseMarker = L.marker([warehouse.lat
      || 10.835067828591106, warehouse.lng || 106.73007578112086], { icon:
      L.divIcon({ className: 'marker-warehouse', html: '<i class="fas
      fa-warehouse"></i>', iconSize: [30, 30] }) }).addTo(map);
      warehouseMarker.bindPopup('<b>Kho h√†ng</b><br>908 Ph·∫°m VƒÉn ƒê·ªìng');
      markerLayers.push(warehouseMarker); } // Add routes for each shipper
      data.routes.forEach((route, index) => { if (route.orders.length === 0)
      return; const color = routeColors[index % routeColors.length]; // Draw
      route geometry if available if (route.geometry &&
      route.geometry.coordinates) { const routeLine = L.geoJSON(route.geometry,
      { style: { color: color, weight: 4, opacity: 0.8 } }).addTo(map);
      routeLayers.push(routeLine); } // Add customer markers
      route.orders.forEach((order, orderIndex) => { if (order.customerLocation)
      { const marker = L.marker([order.customerLocation.lat,
      order.customerLocation.lng], { icon: L.divIcon({ className:
      'marker-customer', html: `${orderIndex + 1}`, iconSize: [25, 25] })
      }).addTo(map); marker.bindPopup(` <b>ƒê∆°n h√†ng #${order.id}</b><br> Kh√°ch
      h√†ng: ${order.customerName || 'N/A'}<br> ƒê·ªãa ch·ªâ: ${order.address ||
      'N/A'}<br> Shipper: ${route.vehicle.name}<br> Th·ª© t·ª±: ${orderIndex + 1}
      `); markerLayers.push(marker); } }); }); // Fit map to show all markers if
      (markerLayers.length > 0) { const group = new
      L.featureGroup(markerLayers); map.fitBounds(group.getBounds().pad(0.1)); }
      } function showRouteSummary(data) { const summary = data.summary; const
      content = ` <div class="route-info"> <strong>T·ªïng quan:</strong><br> üì¶
      ƒê∆°n h√†ng: ${summary.totalOrders}<br> üöõ Shipper:
      ${summary.totalShippers}<br> üìè Qu√£ng ƒë∆∞·ªùng TB:
      ${summary.averageDistance}<br> ‚è±Ô∏è Th·ªùi gian ∆∞·ªõc t√≠nh:
      ${summary.estimatedTime}<br> üß† Thu·∫≠t to√°n: ${summary.algorithm} </div> `;
      document.getElementById('summaryContent').innerHTML = content;
      document.getElementById('routeSummary').style.display = 'block'; }
      function showShipperRoutes(routes) { let content = '';
      routes.forEach((route, index) => { const color = routeColors[index %
      routeColors.length]; const utilization =
      routeData.vehicleUtilization[route.vehicleId] || {}; content += ` <div
      class="shipper-route" onclick="highlightRoute(${index})"> <div
      class="d-flex justify-content-between align-items-center"> <div> <span
      class="route-colors" style="background-color: ${color}"></span>
      <strong>${route.vehicle.name}</strong> </div> <span class="badge
      bg-primary">${route.orders.length} ƒë∆°n</span> </div> <small
      class="text-muted"> üìè ${utilization.routeLength || '0km'} | ‚è±Ô∏è
      ${utilization.estimatedTime || '0 ph√∫t'} | üìä T·∫£i:
      ${utilization.loadUtilization || '0%'} </small> </div> `; });
      document.getElementById('routesContent').innerHTML = content;
      document.getElementById('shipperRoutes').style.display = 'block'; }
      function highlightRoute(routeIndex) { // Remove previous highlights
      document.querySelectorAll('.shipper-route').forEach(el => {
      el.classList.remove('active'); }); // Highlight selected route
      document.querySelectorAll('.shipper-route')[routeIndex]?.classList.add('active');
      // TODO: Highlight route on map (change opacity of others) } async
      function testOSRM() { showLoading(true, 'ƒêang test OSRM server...'); try {
      const response = await fetch('/api/routes/test-osrm', { headers: {
      'Authorization': `Bearer ${getAuthToken()}` } }); const result = await
      response.json(); if (result.success) { let message = 'OSRM Server ho·∫°t
      ƒë·ªông b√¨nh th∆∞·ªùng!\n\n'; result.data.testResults.forEach(test => { message
      += `${test.from} ‚Üí ${test.to}: ${test.distance} (${test.duration})\n`; });
      alert(message); } else { alert(`OSRM Error:
      ${result.message}\n\nSuggestion: ${result.suggestion || ''}`); } } catch
      (error) { alert('L·ªói k·∫øt n·ªëi server khi test OSRM'); console.error('OSRM
      test error:', error); } finally { showLoading(false); } } function
      clearMap() { // Clear all route layers routeLayers.forEach(layer =>
      map.removeLayer(layer)); routeLayers = []; // Clear all marker layers
      markerLayers.forEach(layer => map.removeLayer(layer)); markerLayers = [];
      } function showLoading(show, message = 'ƒêang t·ªëi ∆∞u tuy·∫øn ƒë∆∞·ªùng...') {
      const overlay = document.getElementById('loadingOverlay'); if (show) {
      overlay.querySelector('p').textContent = message; overlay.style.display =
      'block'; } else { overlay.style.display = 'none'; } } function
      showAlert(type, message) { // Create bootstrap alert const alertDiv =
      document.createElement('div'); alertDiv.className = `alert alert-${type}
      alert-dismissible fade show`; alertDiv.innerHTML = ` ${message} <button
      type="button" class="btn-close" data-bs-dismiss="alert"></button> `;
      document.querySelector('.container-fluid').insertBefore(alertDiv,
      document.querySelector('.row')); // Auto dismiss after 5 seconds
      setTimeout(() => { alertDiv.remove(); }, 5000); } function getAuthToken()
      { // Get JWT token from localStorage or cookie return
      localStorage.getItem('authToken') || ''; }
    </script>
  </body>
</html>