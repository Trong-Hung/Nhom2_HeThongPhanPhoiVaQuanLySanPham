<!-- filepath: src/resources/view/admin/order_detail.hbs -->
<div class="container mt-4">
  <div class="card shadow mb-4">
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0">Chi ti·∫øt ƒë∆°n h√†ng</h4>
    </div>
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-md-6">
          <p><strong>M√£ ƒë∆°n:</strong> {{order._id}}</p>
          <p><strong>Kh√°ch h√†ng:</strong> {{order.name}}</p>
          <p><strong>SƒêT:</strong> {{order.phone}}</p>
          <p><strong>ƒê·ªãa ch·ªâ giao:</strong> {{order.address}}</p>
        </div>
        <div class="col-md-6">
          <p><strong>Kho l·∫•y h√†ng:</strong> {{#if order.warehouseId}}{{order.warehouseId.name}}{{/if}}</p>
          <p><strong>ƒê·ªãa ch·ªâ kho:</strong> {{#if order.warehouseId}}{{order.warehouseId.address}}{{/if}}</p>
          <p><strong>Shipper ph·ª• tr√°ch:</strong>
            {{#if order.assignedShipper}}
              {{order.assignedShipper.name}}
            {{else}}
              <span class="text-danger">Ch∆∞a g√°n shipper</span>
            {{/if}}
          </p>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-4">
          <p><strong>Tr·∫°ng th√°i:</strong> <span class="badge bg-info text-dark">{{order.status}}</span></p>
        </div>
        <div class="col-md-4">
          <p><strong>H√¨nh th·ª©c thanh to√°n:</strong> {{paymentMethodText}}</p>
        </div>
        <div class="col-md-4">
          <p><strong>Ng√†y ƒë·∫∑t:</strong> {{order.createdAt}}</p>
          <p><strong>Khung gi·ªù giao h√†ng d·ª± ki·∫øn:</strong> 
  {{#if order.deliveryTimeWindow}}
    {{order.deliveryTimeWindow}}
  {{else}}
    <span class="text-danger">Ch∆∞a x√°c ƒë·ªãnh</span>
  {{/if}}
</p>
        </div>
      </div>
      <h5 class="mt-4 mb-3">üõí Danh s√°ch m·∫∑t h√†ng trong ƒë∆°n</h5>
      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th>T√™n s·∫£n ph·∫©m</th>
              <th>Gi√°</th>
              <th>S·ªë l∆∞·ª£ng</th>
              <th>Th√†nh ti·ªÅn</th>
            </tr>
          </thead>
          <tbody>
            {{#each order.items}}
              <tr>
                <td>{{this.name}}</td>
                <td>{{this.price}} ‚Ç´</td>
                <td>{{this.quantity}}</td>
                <td class="fw-bold text-success">{{multiply this.price this.quantity}} ‚Ç´</td>
              </tr>
            {{/each}}
          </tbody>
        </table>
      </div>

      <!-- G√°n Shipper & Xe Section -->
     <div class="alert alert-warning mt-4">
  <h6><i class="fas fa-exclamation-triangle"></i> G√°n shipper v√† xe cho ƒë∆°n h√†ng</h6>
  <form method="POST" action="/admin/donhang/{{order._id}}/assign-shipper-truck" class="row g-2 align-items-center">
    <div class="col-md-5">
      <label for="shipperId" class="form-label mb-0">Ch·ªçn shipper:</label>
      <select name="shipperId" id="shipperId" class="form-select form-select-sm" required onchange="autoSelectTruck()">
        <option value="">-- Ch·ªçn shipper --</option>
        {{#each shippers}}
          <option value="{{this._id}}" data-truck="{{this.truck}}">
            {{this.name}} ({{this.region}})
          </option>
        {{/each}}
      </select>
    </div>
    <div class="col-md-5">
      <label for="truckId" class="form-label mb-0">Ch·ªçn xe:</label>
      <select name="truckId" id="truckId" class="form-select form-select-sm">
        <option value="">-- Ch·ªçn xe --</option>
        {{#each trucks}}
          <option value="{{this._id}}">
            {{this.licensePlate}} - {{this.type}} ({{this.maxWeight}}kg, {{this.boxVolumeM3}} m¬≥)
          </option>
        {{/each}}
      </select>
    </div>
    <div class="col-md-2 d-flex align-items-end gap-2">
      <button type="submit" class="btn btn-primary w-100">C·∫≠p nh·∫≠t</button>
    </div>
  </form>
  <form method="POST" action="/admin/donhang/{{order._id}}/auto-assign-best" class="mt-2">
    <button type="submit" class="btn btn-info w-100">T·ª± ƒë·ªông g√°n t·ªët nh·∫•t</button>
  </form>
</div>
<script>
  function autoSelectTruck() {
    var shipperSelect = document.getElementById('shipperId');
    var truckSelect = document.getElementById('truckId');
    var selectedOption = shipperSelect.options[shipperSelect.selectedIndex];
    var truckId = selectedOption.getAttribute('data-truck');
    if (truckId) {
      for (var i = 0; i < truckSelect.options.length; i++) {
        if (truckSelect.options[i].value === truckId) {
          truckSelect.selectedIndex = i;
          return;
        }
      }
    }
    truckSelect.selectedIndex = 0;
  }
</script>

      <!-- Th√¥ng tin xe ƒë√£ g√°n -->
      {{#if order.assignedTruck}}
      <div class="alert alert-info mt-4">
        <h6><i class="fas fa-truck"></i> Xe v·∫≠n chuy·ªÉn ƒë√£ g√°n</h6>
        <p>
          <strong>Bi·ªÉn s·ªë:</strong> {{order.assignedTruck.licensePlate}}<br>
          <strong>Lo·∫°i xe:</strong> {{order.assignedTruck.type}}<br>
          <strong>T·∫£i tr·ªçng:</strong> {{order.assignedTruck.maxWeight}} kg<br>
          <strong>Th·ªÉ t√≠ch:</strong> {{order.assignedTruck.boxVolumeM3}} m¬≥
        </p>

      </div>
      {{/if}}

      <!-- Th√¥ng tin Shipper hi·ªán t·∫°i -->
      {{#if order.assignedShipper}}
      <div class="alert alert-success mt-4">
        <h6><i class="fas fa-shipping-fast"></i> Th√¥ng tin shipper ph·ª• tr√°ch</h6>
        <div class="row">
          <div class="col-md-6">
            <p><strong>Shipper:</strong> {{order.assignedShipper.name}}</p>
            <p><strong>V√πng:</strong> {{order.assignedShipper.region}}</p>
          </div>
          <div class="col-md-6 text-end">
            <form method="POST" action="/admin/donhang/{{order._id}}/unassign-shipper-truck
" style="display: inline;">
              <button type="submit" class="btn btn-outline-danger btn-sm" 
                      onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy g√°n shipper n√†y?')">
                <i class="fas fa-user-times"></i> H·ªßy g√°n
              </button>
            </form>
          </div>
        </div>
      </div>
      {{/if}}

      <div class="d-flex justify-content-between align-items-center mt-4">
        <form method="POST" action="/admin/donhang/update/{{order._id}}" class="d-flex align-items-center gap-2">
          <label for="status" class="me-2 mb-0">C·∫≠p nh·∫≠t tr·∫°ng th√°i:</label>
          <select name="status" id="status" class="form-select form-select-sm w-auto">
            <option value="Ch·ªù x√°c nh·∫≠n" {{#if (eq order.status "Ch·ªù x√°c nh·∫≠n")}}selected{{/if}}>Ch·ªù x√°c nh·∫≠n</option>
            <option value="ƒêang s·∫Øp x·∫øp" {{#if (eq order.status "ƒêang s·∫Øp x·∫øp")}}selected{{/if}}>ƒêang s·∫Øp x·∫øp</option>
            <option value="ƒêang v·∫≠n chuy·ªÉn" {{#if (eq order.status "ƒêang v·∫≠n chuy·ªÉn")}}selected{{/if}}>ƒêang v·∫≠n chuy·ªÉn</option>
            <option value="ƒê√£ giao" {{#if (eq order.status "ƒê√£ giao")}}selected{{/if}}>ƒê√£ giao</option>
            <option value="ƒê√£ h·ªßy" {{#if (eq order.status "ƒê√£ h·ªßy")}}selected{{/if}}>ƒê√£ h·ªßy</option>
          </select>
          <button class="btn btn-primary btn-sm">C·∫≠p nh·∫≠t</button>
        </form>
        <a href="/admin/qldonhang" class="btn btn-outline-secondary btn-sm">‚Üê Quay l·∫°i danh s√°ch</a>
      </div>
    </div>
  </div>
</div>