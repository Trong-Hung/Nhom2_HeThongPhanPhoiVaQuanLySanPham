<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EXVN</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/app.css" />
    {{{_sections.css}}}
  </head>
  <body>
    <div class="app">
        {{> header}}

       {{!-- {{> baner}} --}}

        <div class="container">
            {{{body}}}
        </div>

        {{> footer}}
    </div>
    <!-- Modal for New Order Notifications -->
{{#if user}}
  {{#if (eq user.role "admin")}}
    <div class="modal fade" id="newOrdersModal" tabindex="-1" role="dialog" aria-labelledby="newOrdersModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title" id="newOrdersModalLabel">
              <i class="fas fa-bell"></i> ƒê∆°n H√†ng M·ªõi
            </h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="newOrdersModalBody">
            <div class="text-center">
              <div class="spinner-border" role="status">
                <span class="sr-only">ƒêang t·∫£i...</span>
              </div>
              <p>ƒêang t·∫£i th√¥ng tin ƒë∆°n h√†ng...</p>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
            <a href="/admin/qldonhang" class="btn btn-primary">
              <i class="fas fa-list"></i> Xem T·∫•t C·∫£ ƒê∆°n H√†ng
            </a>
          </div>
        </div>
      </div>
    </div>
  {{/if}}
{{/if}}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

<!-- Notification System -->
<script>
$(document).ready(function() {
  // Check for notifications every 30 seconds
  setInterval(checkNotifications, 30000);
  checkNotifications(); // Check immediately on load
  
  function checkNotifications() {
    console.log('üîî Checking notifications...');
    
    // Check unread chat messages
    $.get('/chat/unread-count')
      .done(function(response) {
        if (response.success && response.data.unreadCount > 0) {
          // Only show if not recently cleared
          const chatCleared = localStorage.getItem('chatNotificationCleared');
          const clearTime = chatCleared ? parseInt(chatCleared) : 0;
          const now = Date.now();
          
          // Show notification if cleared more than 5 minutes ago or never cleared
          if (now - clearTime > 5 * 60 * 1000) {
            $('#chatBadge').text(response.data.unreadCount).show();
          }
        } else {
          $('#chatBadge').hide();
          // Clear the localStorage if no unread messages
          localStorage.removeItem('chatNotificationCleared');
        }
      })
      .fail(function() {
        $('#chatBadge').hide();
      });
    
    // Check pending orders for admin
    if (window.userRole === 'admin') {
      console.log('üì¶ Checking pending orders for admin...');
      $.get('/admin/api/new-orders-count')
        .done(function(response) {
          console.log('üì¶ API Response:', response);
          if (response.success && response.data.newOrdersCount > 0) {
            console.log('üì¶ Showing badge with count:', response.data.newOrdersCount);
            $('#orderBadge').text(response.data.newOrdersCount).show();
          } else {
            console.log('üì¶ No pending orders, hiding badge');
            $('#orderBadge').hide();
          }
        })
        .fail(function(xhr, status, error) {
          console.error('‚ùå API Error:', status, error);
          $('#orderBadge').hide();
        });
    }
  }
  
  // Clear notification when clicked
  $('#chatLink').click(function() {
    $('#chatBadge').hide();
    localStorage.setItem('chatNotificationCleared', Date.now());
  });
  
  // Show modal instead of redirect for order notifications
  $('#orderNotificationLink').click(function(e) {
    if (window.userRole === 'admin') {
      e.preventDefault(); // Prevent default link behavior
      $('#orderBadge').hide(); // ·∫®n t·∫°m th·ªùi khi click
      showNewOrdersModal();
    }
  });
  
  // Function to show new orders modal
  function showNewOrdersModal() {
    $('#newOrdersModal').modal('show');
    loadNewOrdersDetails();
  }
  
  // Function to load new orders details
  function loadNewOrdersDetails() {
    $.get('/admin/api/new-orders-details')
      .done(function(response) {
        if (response.success && response.data.orders.length > 0) {
          displayNewOrders(response.data);
        } else {
          $('#newOrdersModalBody').html(`
            <div class="text-center text-muted">
              <i class="fas fa-info-circle fa-3x mb-3"></i>
              <h5>Kh√¥ng c√≥ ƒë∆°n h√†ng m·ªõi</h5>
              <p>Hi·ªán t·∫°i kh√¥ng c√≥ ƒë∆°n h√†ng m·ªõi n√†o trong 24h qua.</p>
            </div>
          `);
        }
      })
      .fail(function() {
        $('#newOrdersModalBody').html(`
          <div class="text-center text-danger">
            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
            <h5>L·ªói t·∫£i d·ªØ li·ªáu</h5>
            <p>Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i.</p>
          </div>
        `);
      });
  }
  
  // Function to display new orders
  function displayNewOrders(data) {
    let html = `
      <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle"></i>
        <strong>B·∫°n c√≥ ${data.count} ƒë∆°n h√†ng ch·ªù x√°c nh·∫≠n</strong> c·∫ßn x·ª≠ l√Ω v√† g·ª≠i ƒë·∫øn ng∆∞·ªùi mua.
      </div>
      <div class="row">
    `;
    
    data.orders.forEach(function(order) {
      const orderDate = new Date(order.createdAt);
      const timeAgo = getTimeAgo(orderDate);
      
      html += `
        <div class="col-12 mb-3">
          <div class="card border-warning">
            <div class="card-body">
              <div class="row">
                <div class="col-md-8">
                  <h6 class="card-title text-primary">
                    <i class="fas fa-user"></i> ${order.customerName}
                  </h6>
                  <p class="mb-1">
                    <i class="fas fa-phone text-success"></i> ${order.customerPhone}
                  </p>
                  <p class="mb-1">
                    <i class="fas fa-map-marker-alt text-danger"></i> ${order.address.length > 50 ? order.address.substring(0, 50) + '...' : order.address}
                  </p>
                  <p class="mb-0 text-muted small">
                    <i class="fas fa-clock"></i> ${timeAgo}
                  </p>
                </div>
                <div class="col-md-4 text-right">
                  <h5 class="text-success">
                    <i class="fas fa-money-bill-wave"></i> ${formatCurrency(order.totalPrice)}
                  </h5>
                  <p class="mb-1">
                    <i class="fas fa-box"></i> ${order.totalQuantity} s·∫£n ph·∫©m
                  </p>
                  <a href="/admin/donhang/${order._id}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-eye"></i> Xem chi ti·∫øt
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    $('#newOrdersModalBody').html(html);
  }
  
  // Helper function to format currency
  function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND',
      minimumFractionDigits: 0
    }).format(amount);
  }
  
  // Helper function to get time ago
  function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    
    if (diffMins < 60) {
      return diffMins <= 1 ? 'V·ª´a xong' : `${diffMins} ph√∫t tr∆∞·ªõc`;
    } else if (diffHours < 24) {
      return `${diffHours} gi·ªù tr∆∞·ªõc`;
    } else {
      return date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});
    }
  }
});

// Set user role for JavaScript
{{#if user}}
window.userRole = '{{user.role}}';
{{/if}}
</script>
{{{_sections.js}}}
  </body>
</html>
